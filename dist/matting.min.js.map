{"version":3,"file":"matting.min.js","sources":["../src/index.js"],"sourcesContent":["// import is from '@meitu/is';\nexport default function matting(options){\n    if(!options.image){\n        console.error('there must be a image contains mask and result.');\n        return;\n    }\n    let image = options.image;\n    let ops = extend({\n        export_quality: .9,\n        export_type : 'base64',   // canvas dom or base64;\n        mask_zoom : 0.5 ,   // 0 < mask_zoom <= 1\n        success(){},\n        error(){},\n    }, options);\n\n    let origin, originCtx, mask, maskCtx, result, resultCtx;\n\n    loadImage(image, imgEl => {\n        console.dir(image);\n        // 绘制原图；\n        origin = document.createElement('canvas');\n        originCtx = origin.getContext('2d');\n        origin.width = imgEl.naturalWidth;\n        origin.height = imgEl.naturalHeight / 2;\n        originCtx.drawImage(imgEl, 0, 0);\n\n        // 绘制mask；\n        mask = document.createElement('canvas');\n        maskCtx = mask.getContext('2d');\n        mask.width = imgEl.naturalWidth * ops.mask_zoom;\n        mask.height = imgEl.naturalHeight * ops.mask_zoom / 2;\n        maskCtx.drawImage(imgEl, 0, - imgEl.naturalHeight * ops.mask_zoom / 2, imgEl.naturalWidth * ops.mask_zoom , imgEl.naturalHeight * ops.mask_zoom);\n\n        // 去除mask图黑色背景；\n        let maskData = maskCtx.getImageData(0, 0, mask.width, mask.height);\n        filter(maskData.data);\n        maskCtx.putImageData(maskData, 0, 0);\n\n        result = document.createElement('canvas');\n        resultCtx = result.getContext('2d');\n        result.width = imgEl.naturalWidth;\n        result.height = imgEl.naturalHeight / 2;\n\n        resultCtx.drawImage(mask, 0, 0, imgEl.naturalWidth, imgEl.naturalHeight / 2);\n\n        resultCtx.globalCompositeOperation = 'source-in';\n\n        resultCtx.drawImage(origin, 0, 0);\n\n        if(ops.export_type == 'canvas'){\n            ops.success(result);\n        }else{\n            ops.success(result.toDataURL(`image/png`, ops.quality));\n        }\n    }, err => {\n        ops.error(err);\n    });\n}\n\nfunction loadImage(image, cbk, error){\n    if(typeof image == 'string'){\n        let img = new Image();\n        img.crossOrigin = '*';\n        img.onload = () => {\n            cbk(img);\n        };\n        img.onerror = () => {\n            console.error('load image error!');\n            error(image);\n        };\n        img.src = image + `?${new Date().getTime()}`;\n    }else{\n        cbk(image);\n    }\n}\nfunction filter(data) {\n    for (let i = 0; i < data.length; i += 4) {\n        let r = data[i],\n            g = data[i + 1],\n            b = data[i + 2];\n\n        if (r <= 30 && g <= 30 && b<= 30) {\n            data[i + 3] = 0;\n        }\n    }\n}\nfunction extend(obj1, obj2) {\n    for (let k in obj2) {\n        if (obj2.hasOwnProperty(k)) {\n            if (typeof obj2[k] == 'object') {\n                if (typeof obj1[k] !== 'object' || obj1[k] === null) {\n                    obj1[k] = {};\n                }\n                extend(obj1[k], obj2[k]);\n            } else {\n                obj1[k] = obj2[k];\n            }\n        }\n    }\n    return obj1;\n}\n"],"names":["matting","options","image","error","ops","extend","origin","originCtx","mask","maskCtx","result","resultCtx","dir","document","createElement","getContext","width","imgEl","naturalWidth","height","naturalHeight","drawImage","mask_zoom","maskData","getImageData","data","putImageData","globalCompositeOperation","export_type","success","toDataURL","quality","err","loadImage","cbk","img","Image","crossOrigin","onload","onerror","src","Date","getTime","filter","i","length","r","g","b","obj1","obj2","k","hasOwnProperty","_typeof"],"mappings":"kLACA,SAAwBA,GAAQC,OACxBA,EAAQC,0BACAC,MAAM,sDAGdD,GAAQD,EAAQC,MAChBE,EAAMC,kBACU,eACF,mBACF,4CAGbJ,GAECK,SAAQC,SAAWC,SAAMC,SAASC,SAAQC,WAEpCT,EAAO,oBACLU,IAAIV,KAEHW,SAASC,cAAc,YACpBR,EAAOS,WAAW,QACvBC,MAAQC,EAAMC,eACdC,OAASF,EAAMG,cAAgB,IAC5BC,UAAUJ,EAAO,EAAG,KAGvBJ,SAASC,cAAc,YACpBN,EAAKO,WAAW,QACrBC,MAAQC,EAAMC,aAAed,EAAIkB,YACjCH,OAASF,EAAMG,cAAgBhB,EAAIkB,UAAY,IAC5CD,UAAUJ,EAAO,GAAKA,EAAMG,cAAgBhB,EAAIkB,UAAY,EAAGL,EAAMC,aAAed,EAAIkB,UAAYL,EAAMG,cAAgBhB,EAAIkB,cAGlIC,GAAWd,EAAQe,aAAa,EAAG,EAAGhB,EAAKQ,MAAOR,EAAKW,UACpDI,EAASE,QACRC,aAAaH,EAAU,EAAG,KAEzBV,SAASC,cAAc,YACpBJ,EAAOK,WAAW,QACvBC,MAAQC,EAAMC,eACdC,OAASF,EAAMG,cAAgB,IAE5BC,UAAUb,EAAM,EAAG,EAAGS,EAAMC,aAAcD,EAAMG,cAAgB,KAEhEO,yBAA2B,cAE3BN,UAAUf,EAAQ,EAAG,GAET,UAAnBF,EAAIwB,cACCC,QAAQnB,KAERmB,QAAQnB,EAAOoB,sBAAuB1B,EAAI2B,WAEnD,cACK5B,MAAM6B,KAIlB,QAASC,GAAU/B,EAAOgC,EAAK/B,MACR,gBAATD,GAAkB,IACpBiC,GAAM,GAAIC,SACVC,YAAc,MACdC,OAAS,aACLH,MAEJI,QAAU,mBACFpC,MAAM,uBACRD,MAENsC,IAAMtC,OAAY,GAAIuC,OAAOC,iBAE7BxC,GAGZ,QAASyC,GAAOlB,OACP,GAAImB,GAAI,EAAGA,EAAInB,EAAKoB,OAAQD,GAAK,EAAG,IACjCE,GAAIrB,EAAKmB,GACTG,EAAItB,EAAKmB,EAAI,GACbI,EAAIvB,EAAKmB,EAAI,EAEbE,IAAK,IAAMC,GAAK,IAAMC,GAAI,OACrBJ,EAAI,GAAK,IAI1B,QAASvC,GAAO4C,EAAMC,OACb,GAAIC,KAAKD,GACNA,EAAKE,eAAeD,KACE,UAAlBE,EAAOH,EAAKC,KACW,WAAnBE,EAAOJ,EAAKE,KAA+B,OAAZF,EAAKE,OAC/BA,SAEFF,EAAKE,GAAID,EAAKC,OAEhBA,GAAKD,EAAKC,UAIpBF"}